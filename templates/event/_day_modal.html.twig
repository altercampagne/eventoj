{% macro render_availability(name, value, max) %}
{% set percent = (max - value) * 100 / max %}

<div class="col-12 col-sm-4">
    <div class="row">
        <div class="col-4 col-sm-12">
            <div class="text-center">{{ name }}</div>
        </div>
        <div class="col col-sm-12 align-self-center">
            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="{{ max - value }}" aria-valuemin="0" aria-valuemax="{{ max }}">
                <div class="progress-bar text-bg-{{ percent > 75 ? 'danger' : percent > 50 ? 'warning' : 'success' }}" style="width: {{ percent }}%">
                    {{ max -value }} / {{ max }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<div class="modal" id="{{ id }}" tabindex="-1" aria-labelledby="{{ title }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-body p-0">
                <div class="list-group list-group-flush">
                    {% for stage in event.stages %}
                        {# Storage this data in a variable to avoid too many computations #}
                        {% set availability = stage.availability %}
                        {% set isFull = availability.adults == 0 %}

                        <div
                            class="list-group-item {% if isFull %}list-group-item-secondary{% endif %} pb-0 px-0"
                            {% if isFull %} disabled{% endif %}
                            data-full={{ isFull ? 1 : 0 }}
                            data-stage="{{ stage.id }}"
                        >
                            <div class="d-flex justify-content-between align-items-center px-2 pb-2">
                                <div>
                                    <h6 class="my-0"><b>{{ stage.date|format_date }}</b> - {{ stage.name }}</h6>
                                    {% if not isFull %}
                                        <div class="content-for-available-stage-only">
                                            <button
                                                class="btn btn-link btn-sm text-muted content-for-available-stage-only"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#details-{{ stage.id }}"
                                                type="button"
                                                aria-expanded="false"
                                                aria-controls="details-{{ stage.id }}"
                                            >
                                                <i class="fa-solid fa-caret-right"></i> afficher les dÃ©tails
                                            </button>
                                            {% if stage.isBefore %}
                                                <span class="badge bg-primary bg-opacity-50">BEFORE</span>
                                            {% elseif stage.isAfter %}
                                                <span class="badge bg-primary bg-opacity-50">AFTER</span>
                                            {% endif %}
                                            {% if availability.bikes == 0 %}
                                                <span class="badge bg-danger bg-opacity-50">Plus de vÃ©lo disponible</span>
                                            {% endif %}
                                            {% if availability.adults <= 5 %}
                                                <span class="badge bg-warning bg-opacity-75">ðŸ“¢ DerniÃ¨res places !</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary {{ isFull ? 'd-none' }}" data-stage="{{ stage.id }}">GOÂ !</button>
                                    <span class="badge bg-secondary d-none content-for-unavailable-stage-only">INDISPONIBLE</span>
                                    {% if isFull %}
                                        <span class="badge bg-secondary">COMPLET</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if not isFull %}
                                <div class="stageAvailability container">
                                    <div class="collapse bg-light row p-2 pb-3" id="details-{{ stage.id }}">
                                        {{ _self.render_availability('Adultes', availability.adults, event.adultsCapacity) }}
                                        {{ _self.render_availability('- de 13 ans', availability.children, event.childrenCapacity) }}
                                        {{ _self.render_availability('VÃ©los', availability.bikes, event.bikesAvailable) }}
                                    </div>
                                </div>
                            {% endif %}

                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
